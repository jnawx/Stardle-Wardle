<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Star Wars Character Manager Pro</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #fff;
      padding: 20px;
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
    }
    
    header {
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 30px;
      border: 2px solid #FFE81F;
    }
    
    h1 {
      color: #FFE81F;
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .stats {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .stat-box {
      background: rgba(255, 232, 31, 0.1);
      padding: 15px 25px;
      border-radius: 8px;
      border: 1px solid #FFE81F;
    }
    
    .stat-label {
      font-size: 0.9em;
      color: #aaa;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #FFE81F;
    }
    
    .controls {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      border: 1px solid #333;
    }
    
    .search-box {
      flex: 1;
      min-width: 300px;
    }
    
    .search-box input {
      width: 100%;
      padding: 12px 20px;
      font-size: 16px;
      border: 2px solid #FFE81F;
      border-radius: 8px;
      background: #2a2a2a;
      color: #fff;
    }
    
    .search-box input:focus {
      outline: none;
      box-shadow: 0 0 10px rgba(255, 232, 31, 0.5);
    }
    
    .filter-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 24px;
      font-size: 14px;
      font-weight: bold;
      border: 2px solid #FFE81F;
      border-radius: 8px;
      background: #FFE81F;
      color: #000;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    button:hover {
      background: #fff;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255, 232, 31, 0.3);
    }
    
    button.secondary {
      background: transparent;
      color: #FFE81F;
    }
    
    button.secondary:hover {
      background: rgba(255, 232, 31, 0.1);
    }
    
    button.danger {
      background: #ef4444;
      border-color: #ef4444;
      color: #fff;
    }
    
    button.danger:hover {
      background: #dc2626;
      border-color: #dc2626;
    }
    
    .character-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 30px;
    }
    
    .character-row {
      background: #1a1a1a;
      border: 2px solid #333;
      border-radius: 10px;
      padding: 20px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 20px;
      align-items: start;
      transition: all 0.3s;
    }
    
    .character-row:hover {
      border-color: #FFE81F;
      box-shadow: 0 5px 15px rgba(255, 232, 31, 0.2);
    }
    
    .character-row.enabled {
      border-color: #4ade80;
      background: rgba(74, 222, 128, 0.05);
    }
    
    .character-row.marked-delete {
      border-color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
      opacity: 0.7;
    }
    
    .character-controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 120px;
    }
    
    .character-info {
      flex: 1;
    }
    
    .character-name {
      font-size: 1.3em;
      font-weight: bold;
      color: #FFE81F;
      margin-bottom: 15px;
    }
    
    .character-actions {
      display: flex;
      gap: 10px;
      flex-direction: column;
    }
    
    .character-actions button {
      padding: 8px 16px;
      font-size: 12px;
    }
    
    .attribute-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }
    
    .attribute-field {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .attribute-label {
      font-size: 0.85em;
      color: #aaa;
      font-weight: 600;
    }
    
    .attribute-input {
      padding: 8px 12px;
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 6px;
      color: #fff;
      font-size: 14px;
    }
    
    .attribute-input:focus {
      outline: none;
      border-color: #FFE81F;
    }
    
    select.attribute-input {
      cursor: pointer;
    }
    
    textarea.attribute-input {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: 60px;
      resize: vertical;
    }
    
    .multi-select {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      padding: 8px;
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 6px;
      min-height: 38px;
    }
    
    .multi-select-tag {
      background: #FFE81F;
      color: #000;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .multi-select-tag .remove {
      cursor: pointer;
      font-weight: bold;
      color: #ef4444;
    }
    
    .multi-select-add {
      background: transparent;
      border: none;
      color: #888;
      cursor: pointer;
      padding: 4px 10px;
      font-size: 12px;
    }
    
    .multi-select-add:hover {
      color: #FFE81F;
    }
    
    .dropdown-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .dropdown-overlay.show {
      display: flex;
    }
    
    .dropdown-content {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #FFE81F;
      max-width: 400px;
      width: 90%;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .dropdown-option {
      padding: 10px;
      cursor: pointer;
      border-radius: 5px;
      margin: 5px 0;
    }
    
    .dropdown-option:hover {
      background: #2a2a2a;
    }
    
    .checkbox-custom {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #4ade80;
    }
    
    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.5em;
      color: #FFE81F;
    }
    
    .save-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #4ade80;
      color: #000;
      padding: 15px 30px;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(74, 222, 128, 0.4);
      display: none;
      z-index: 1000;
    }
    
    .save-indicator.show {
      display: block;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .status-badges {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: bold;
    }
    
    .status-badge.enabled {
      background: #4ade80;
      color: #000;
    }
    
    .status-badge.disabled {
      background: #666;
      color: #fff;
    }
    
    .status-badge.delete {
      background: #ef4444;
      color: #fff;
    }
    
    .status-badge.incomplete {
      background: #f59e0b;
      color: #000;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>‚≠ê Star Wars Character Manager Pro</h1>
      <p>Enable/disable characters and edit their attributes</p>
      <div class="stats">
        <div class="stat-box">
          <div class="stat-label">Total Characters</div>
          <div class="stat-value" id="totalCount">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Enabled</div>
          <div class="stat-value" id="enabledCount" style="color: #4ade80;">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Disabled</div>
          <div class="stat-value" id="disabledCount" style="color: #666;">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Marked for Delete</div>
          <div class="stat-value" id="deleteCount" style="color: #ef4444;">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Incomplete Data</div>
          <div class="stat-value" id="incompleteCount" style="color: #f59e0b;">0</div>
        </div>
      </div>
    </header>

    <div class="controls">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="üîç Search characters..." />
      </div>
      <div class="filter-group">
        <button onclick="filterView('all')" class="secondary">All</button>
        <button onclick="filterView('enabled')" class="secondary">Enabled Only</button>
        <button onclick="filterView('disabled')" class="secondary">Disabled Only</button>
        <button onclick="filterView('incomplete')" class="secondary">Incomplete Data</button>
        <button onclick="filterView('marked-delete')" class="secondary">Marked for Delete</button>
      </div>
      <button onclick="createNewCharacter()" style="background: #3b82f6; border-color: #3b82f6;">‚ûï Create New Character</button>
      <button onclick="openFindReplace()" style="background: #8b5cf6; border-color: #8b5cf6;">üîÑ Find & Replace</button>
      <button onclick="enableAll()">‚úÖ Enable All Visible</button>
      <button onclick="disableAll()">‚ùå Disable All Visible</button>
      <button onclick="saveChanges()" style="background: #4ade80;">üíæ Save Changes</button>
    </div>

    <div class="loading" id="loading">Loading characters...</div>
    <div class="character-list" id="characterList"></div>
  </div>

  <div class="save-indicator" id="saveIndicator">‚úÖ Changes copied to clipboard!</div>

  <!-- Multi-select dropdown overlay -->
  <div class="dropdown-overlay" id="dropdownOverlay" onclick="closeDropdown(event)">
    <div class="dropdown-content" onclick="event.stopPropagation()">
      <h3 style="color: #FFE81F; margin-bottom: 15px;" id="dropdownTitle">Select Options</h3>
      <div id="dropdownOptions"></div>
      <button onclick="closeDropdown()" style="width: 100%; margin-top: 15px;">Done</button>
    </div>
  </div>

  <!-- Create new character modal -->
  <div class="dropdown-overlay" id="createCharacterModal">
    <div class="dropdown-content" onclick="event.stopPropagation()" style="max-width: 500px;">
      <h3 style="color: #FFE81F; margin-bottom: 20px;">‚ûï Create New Character</h3>
      
      <div style="display: flex; flex-direction: column; gap: 15px;">
        <div class="attribute-field">
          <div class="attribute-label">Character Name *</div>
          <input type="text" id="newCharName" class="attribute-input" placeholder="Enter character name" style="font-size: 16px;">
        </div>
        
        <div class="attribute-field">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="newCharEnabled" class="checkbox-custom" checked>
            <span style="font-size: 0.9em; color: #aaa;">Enable this character</span>
          </label>
        </div>

        <div style="background: rgba(255, 232, 31, 0.1); padding: 15px; border-radius: 8px; border: 1px solid #FFE81F;">
          <p style="font-size: 0.9em; color: #FFE81F; margin-bottom: 10px;">‚ÑπÔ∏è <strong>Note:</strong></p>
          <p style="font-size: 0.85em; color: #ccc;">The character will be created with default null values for all attributes. You can edit them after creation.</p>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button onclick="confirmCreateCharacter()" style="flex: 1; background: #3b82f6; border-color: #3b82f6;">Create Character</button>
          <button onclick="closeCreateModal()" class="secondary" style="flex: 1;">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Find & Replace modal -->
  <div class="dropdown-overlay" id="findReplaceModal">
    <div class="dropdown-content" onclick="event.stopPropagation()" style="max-width: 600px;">
      <h3 style="color: #FFE81F; margin-bottom: 20px;">üîÑ Find & Replace Attribute Values</h3>
      
      <div style="display: flex; flex-direction: column; gap: 15px;">
        <div class="attribute-field">
          <div class="attribute-label">Attribute Type *</div>
          <select id="frAttribute" class="attribute-input" onchange="updateFindReplaceOptions()">
            <option value="">-- Select Attribute --</option>
            <option value="species">Species</option>
            <option value="sex">Sex</option>
            <option value="hairColor">Hair Color</option>
            <option value="eyeColor">Eye Color</option>
            <option value="homeworld">Homeworld</option>
            <option value="affiliations">Affiliations</option>
            <option value="eras">Eras</option>
            <option value="weapons">Weapons</option>
            <option value="movieAppearances">Movie Appearances</option>
            <option value="tvAppearances">TV Appearances</option>
            <option value="gameAppearances">Game Appearances</option>
            <option value="bookComicAppearances">Book/Comic Appearances</option>
          </select>
        </div>
        
        <div class="attribute-field">
          <div class="attribute-label">Find Value *</div>
          <select id="frFindValue" class="attribute-input">
            <option value="">-- Select value to find --</option>
          </select>
        </div>

        <div class="attribute-field">
          <div class="attribute-label">Replace With *</div>
          <select id="frReplaceValue" class="attribute-input">
            <option value="">-- Select replacement value --</option>
          </select>
        </div>

        <div id="frPreview" style="background: rgba(139, 92, 246, 0.1); padding: 15px; border-radius: 8px; border: 1px solid #8b5cf6; display: none;">
          <p style="font-size: 0.9em; color: #8b5cf6; margin-bottom: 10px;">üìä <strong>Preview:</strong></p>
          <p id="frPreviewText" style="font-size: 0.85em; color: #ccc;"></p>
        </div>

        <div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 8px; border: 1px solid #ef4444;">
          <p style="font-size: 0.9em; color: #ef4444; margin-bottom: 10px;">‚ö†Ô∏è <strong>Warning:</strong></p>
          <p style="font-size: 0.85em; color: #ccc;">This will replace all occurrences across all characters. This action cannot be undone unless you discard changes without saving.</p>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button onclick="executeFindReplace()" style="flex: 1; background: #8b5cf6; border-color: #8b5cf6;">Replace All</button>
          <button onclick="closeFindReplace()" class="secondary" style="flex: 1;">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let characters = [];
    let attributeOptions = {};
    let filteredCharacters = [];
    let currentFilter = 'all';
    let currentDropdownContext = null;

    async function loadData() {
      try {
        console.log('Fetching characters.json...');
        const charsResponse = await fetch('./src/data/characters.json');
        console.log('Characters response status:', charsResponse.status);
        if (!charsResponse.ok) {
          throw new Error(`Failed to load characters.json: ${charsResponse.status} ${charsResponse.statusText}`);
        }
        
        console.log('Fetching attribute-options.json...');
        const optionsResponse = await fetch('./src/data/attribute-options.json');
        console.log('Options response status:', optionsResponse.status);
        if (!optionsResponse.ok) {
          throw new Error(`Failed to load attribute-options.json: ${optionsResponse.status} ${optionsResponse.statusText}`);
        }
        
        console.log('Parsing JSON...');
        characters = await charsResponse.json();
        attributeOptions = await optionsResponse.json();
        console.log('Loaded', characters.length, 'characters');
        
        // Add markedForDelete flag if not present
        characters.forEach(char => {
          if (char.markedForDelete === undefined) {
            char.markedForDelete = false;
          }
        });
        
        filteredCharacters = [...characters];
        renderCharacters();
        updateStats();
        document.getElementById('loading').style.display = 'none';
      } catch (error) {
        console.error('Error loading data:', error);
        console.error('Error details:', error.message);
        document.getElementById('loading').innerHTML = `‚ùå Error loading data: ${error.message}<br><small>Make sure you're accessing via http://localhost:5176/character-manager-pro.html</small>`;
      }
    }

    function isIncomplete(char) {
      // Check all required fields except aliases
      const hasNoValue = (value) => {
        if (value === null || value === undefined) return true;
        if (typeof value === 'string' && value.trim() === '') return true;
        if (Array.isArray(value) && value.length === 0) return true;
        return false;
      };

      // Required fields (all except aliases and fandomUrl)
      return hasNoValue(char.species) ||
             hasNoValue(char.sex) ||
             hasNoValue(char.hairColor) ||
             hasNoValue(char.eyeColor) ||
             hasNoValue(char.homeworld) ||
             hasNoValue(char.affiliations) ||
             hasNoValue(char.eras) ||
             hasNoValue(char.weapons) ||
             char.forceUser === null ||
             char.forceUser === undefined ||
             char.speaksBasic === null ||
             char.speaksBasic === undefined ||
             hasNoValue(char.quoteHint) ||
             hasNoValue(char.masterHint) ||
             hasNoValue(char.imageUrl) ||
             hasNoValue(char.movieAppearances) ||
             hasNoValue(char.tvAppearances) ||
             hasNoValue(char.gameAppearances) ||
             hasNoValue(char.bookComicAppearances);
    }

    function updateStats() {
      const total = characters.filter(c => !c.markedForDelete).length;
      const enabled = characters.filter(c => c.enabled && !c.markedForDelete).length;
      const disabled = characters.filter(c => !c.enabled && !c.markedForDelete).length;
      const markedDelete = characters.filter(c => c.markedForDelete).length;
      const incomplete = characters.filter(c => isIncomplete(c) && !c.markedForDelete).length;

      document.getElementById('totalCount').textContent = total;
      document.getElementById('enabledCount').textContent = enabled;
      document.getElementById('disabledCount').textContent = disabled;
      document.getElementById('deleteCount').textContent = markedDelete;
      document.getElementById('incompleteCount').textContent = incomplete;
    }

    function filterView(type) {
      currentFilter = type;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      filteredCharacters = characters.filter(char => {
        const matchesSearch = char.name.toLowerCase().includes(searchTerm);
        
        switch(type) {
          case 'enabled':
            return matchesSearch && char.enabled && !char.markedForDelete;
          case 'disabled':
            return matchesSearch && !char.enabled && !char.markedForDelete;
          case 'incomplete':
            return matchesSearch && isIncomplete(char) && !char.markedForDelete;
          case 'marked-delete':
            return matchesSearch && char.markedForDelete;
          default:
            return matchesSearch;
        }
      });
      
      renderCharacters();
    }

    function sortByLastName(a, b) {
      const getLastName = (name) => {
        const parts = name.trim().split(' ');
        return parts[parts.length - 1].toLowerCase();
      };
      return getLastName(a.name).localeCompare(getLastName(b.name));
    }

    function renderCharacters() {
      const list = document.getElementById('characterList');
      list.innerHTML = '';

      // Sort characters alphabetically by last name
      const sortedCharacters = [...filteredCharacters].sort(sortByLastName);

      sortedCharacters.forEach((char, index) => {
        const row = document.createElement('div');
        const classes = ['character-row'];
        if (char.enabled) classes.push('enabled');
        if (char.markedForDelete) classes.push('marked-delete');
        row.className = classes.join(' ');
        
        const charIndex = characters.indexOf(char);
        
        row.innerHTML = `
          <div class="character-controls">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" 
                     class="checkbox-custom" 
                     ${char.enabled ? 'checked' : ''} 
                     onchange="toggleEnabled(${charIndex})"
                     ${char.markedForDelete ? 'disabled' : ''}>
              <span style="font-size: 0.9em;">Enabled</span>
            </label>
            <button class="${char.markedForDelete ? 'secondary' : 'danger'}" 
                    onclick="toggleDelete(${charIndex})"
                    style="font-size: 11px; padding: 6px 12px;">
              ${char.markedForDelete ? '‚Ü©Ô∏è Undo' : 'üóëÔ∏è Delete'}
            </button>
            <button onclick="populateMissingInfo(${charIndex})" 
                    ${char.markedForDelete ? 'disabled' : ''}
                    style="font-size: 10px; padding: 6px 10px; background: #3b82f6; border-color: #3b82f6;">
              üîç Populate Missing
            </button>
            <button onclick="populateAllInfo(${charIndex})" 
                    ${char.markedForDelete ? 'disabled' : ''}
                    style="font-size: 10px; padding: 6px 10px; background: #8b5cf6; border-color: #8b5cf6;">
              ‚ö° Populate All
            </button>
          </div>
          
          <div class="character-info">
            <div class="attribute-field" style="margin-bottom: 10px;">
              <div class="attribute-label">Character Name</div>
              <input type="text" 
                     class="attribute-input" 
                     value="${char.name}" 
                     onchange="updateAttribute(${charIndex}, 'name', this.value)"
                     ${char.markedForDelete ? 'disabled' : ''}
                     style="font-weight: bold; font-size: 1.1em;">
            </div>
            
            <div class="attribute-field" style="margin-bottom: 15px;">
              <div class="attribute-label">Character Image</div>
              <div style="display: flex; gap: 15px; align-items: flex-start;">
                <div style="flex-shrink: 0;">
                  ${char.imageUrl ? 
                    `<img src="${char.imageUrl}" 
                         alt="${char.name}" 
                         style="width: 120px; height: 160px; object-fit: cover; border-radius: 8px; border: 2px solid #FFE81F; background: #2a2a2a;"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <div style="display: none; width: 120px; height: 160px; background: #2a2a2a; border-radius: 8px; border: 2px solid #666; align-items: center; justify-content: center; color: #666; font-size: 0.8em; text-align: center; padding: 10px;">No Image</div>` 
                    : 
                    `<div style="width: 120px; height: 160px; background: #2a2a2a; border-radius: 8px; border: 2px solid #666; display: flex; align-items: center; justify-content: center; color: #666; font-size: 0.8em; text-align: center; padding: 10px;">No Image URL</div>`
                  }
                </div>
                <div style="flex: 1;">
                  <input type="text" 
                         class="attribute-input" 
                         value="${char.imageUrl || ''}" 
                         onchange="updateAttribute(${charIndex}, 'imageUrl', this.value)"
                         ${char.markedForDelete ? 'disabled' : ''}
                         placeholder="Enter image URL"
                         style="margin-bottom: 8px;">
                  <div style="font-size: 0.75em; color: #888;">Enter a full image URL (e.g., https://example.com/image.jpg)</div>
                </div>
              </div>
            </div>
            
            <div class="status-badges">
              ${char.enabled ? '<span class="status-badge enabled">ENABLED</span>' : '<span class="status-badge disabled">DISABLED</span>'}
              ${char.markedForDelete ? '<span class="status-badge delete">MARKED FOR DELETE</span>' : ''}
              ${isIncomplete(char) && !char.markedForDelete ? '<span class="status-badge incomplete">INCOMPLETE</span>' : ''}
            </div>
            
            <div class="attribute-grid">
              <div class="attribute-field">
                <div class="attribute-label">Additional Names (Aliases)</div>
                <div class="multi-select" onclick="${char.markedForDelete ? '' : `openAdditionalNames(${charIndex})`}" style="${char.markedForDelete ? 'opacity: 0.5; cursor: not-allowed;' : 'cursor: pointer;'}">
                  ${(char.additionalNames || []).map(a => 
                    `<span class="multi-select-tag">${a} ${char.markedForDelete ? '' : `<span class="remove" onclick="event.stopPropagation(); removeFromArray(${charIndex}, 'additionalNames', '${a.replace(/'/g, "\\'")}')">√ó</span>`}</span>`
                  ).join('')}
                  ${char.markedForDelete ? '' : '<button class="multi-select-add">+ Add Alias</button>'}
                </div>
              </div>
            
              <div class="attribute-field">
                <div class="attribute-label">Species</div>
                <select class="attribute-input" onchange="updateAttribute(${charIndex}, 'species', this.value)" ${char.markedForDelete ? 'disabled' : ''}>
                  <option value="null" ${char.species === null ? 'selected' : ''}>-- Select --</option>
                  ${attributeOptions.species.map(s => 
                    `<option value="${s}" ${char.species === s ? 'selected' : ''}>${s}</option>`
                  ).join('')}
                </select>
              </div>
              
              <div class="attribute-field">
                <div class="attribute-label">Sex</div>
                <select class="attribute-input" onchange="updateAttribute(${charIndex}, 'sex', this.value)" ${char.markedForDelete ? 'disabled' : ''}>
                  <option value="null" ${char.sex === null ? 'selected' : ''}>-- Select --</option>
                  ${attributeOptions.sex.map(s => 
                    `<option value="${s}" ${char.sex === s ? 'selected' : ''}>${s}</option>`
                  ).join('')}
                </select>
              </div>
              
              <div class="attribute-field">
                <div class="attribute-label">Hair Color</div>
                <select class="attribute-input" onchange="updateAttribute(${charIndex}, 'hairColor', this.value)" ${char.markedForDelete ? 'disabled' : ''}>
                  <option value="null" ${char.hairColor === null ? 'selected' : ''}>-- Select --</option>
                  ${attributeOptions.hairColor.map(h => 
                    `<option value="${h}" ${char.hairColor === h ? 'selected' : ''}>${h}</option>`
                  ).join('')}
                </select>
              </div>
              
              <div class="attribute-field">
                <div class="attribute-label">Eye Color</div>
                <select class="attribute-input" onchange="updateAttribute(${charIndex}, 'eyeColor', this.value)" ${char.markedForDelete ? 'disabled' : ''}>
                  <option value="null" ${char.eyeColor === null ? 'selected' : ''}>-- Select --</option>
                  ${attributeOptions.eyeColor.map(e => 
                    `<option value="${e}" ${char.eyeColor === e ? 'selected' : ''}>${e}</option>`
                  ).join('')}
                </select>
              </div>
              
              <div class="attribute-field">
                <div class="attribute-label">Homeworld</div>
                <select class="attribute-input" onchange="updateAttribute(${charIndex}, 'homeworld', this.value)" ${char.markedForDelete ? 'disabled' : ''}>
                  <option value="null" ${char.homeworld === null ? 'selected' : ''}>-- Select --</option>
                  ${attributeOptions.homeworld.map(h => 
                    `<option value="${h}" ${char.homeworld === h ? 'selected' : ''}>${h}</option>`
                  ).join('')}
                </select>
              </div>
              
              <div class="attribute-field">
                <div class="attribute-label">Affiliations</div>
                <div class="multi-select" onclick="${char.markedForDelete ? '' : `openMultiSelect(${charIndex}, 'affiliations')`}" style="${char.markedForDelete ? 'opacity: 0.5; cursor: not-allowed;' : 'cursor: pointer;'}">
                  ${(char.affiliations || []).map(a => 
                    `<span class="multi-select-tag">${a} ${char.markedForDelete ? '' : `<span class="remove" onclick="event.stopPropagation(); removeFromArray(${charIndex}, 'affiliations', '${a}')">√ó</span>`}</span>`
                  ).join('')}
                  ${char.markedForDelete ? '' : '<button class="multi-select-add">+ Add</button>'}
                </div>
              </div>
              
              <div class="attribute-field">
                <div class="attribute-label">Eras</div>
                <div class="multi-select" onclick="${char.markedForDelete ? '' : `openMultiSelect(${charIndex}, 'eras')`}" style="${char.markedForDelete ? 'opacity: 0.5; cursor: not-allowed;' : 'cursor: pointer;'}">
                  ${(char.eras || []).map(e => 
                    `<span class="multi-select-tag">${e} ${char.markedForDelete ? '' : `<span class="remove" onclick="event.stopPropagation(); removeFromArray(${charIndex}, 'eras', '${e}')">√ó</span>`}</span>`
                  ).join('')}
                  ${char.markedForDelete ? '' : '<button class="multi-select-add">+ Add</button>'}
                </div>
              </div>
              
              <div class="attribute-field">
                <div class="attribute-label">Weapons</div>
                <div class="multi-select" onclick="${char.markedForDelete ? '' : `openMultiSelect(${charIndex}, 'weapons')`}" style="${char.markedForDelete ? 'opacity: 0.5; cursor: not-allowed;' : 'cursor: pointer;'}">
                  ${(char.weapons || []).map(w => 
                    `<span class="multi-select-tag">${w} ${char.markedForDelete ? '' : `<span class="remove" onclick="event.stopPropagation(); removeFromArray(${charIndex}, 'weapons', '${w}')">√ó</span>`}</span>`
                  ).join('')}
                  ${char.markedForDelete ? '' : '<button class="multi-select-add">+ Add</button>'}
                </div>
              </div>
              
              <div class="attribute-field">
                <div class="attribute-label">Force User</div>
                <select class="attribute-input" onchange="updateAttribute(${charIndex}, 'forceUser', this.value === 'true')" ${char.markedForDelete ? 'disabled' : ''}>
                  <option value="false" ${!char.forceUser ? 'selected' : ''}>No</option>
                  <option value="true" ${char.forceUser ? 'selected' : ''}>Yes</option>
                </select>
              </div>
              
              <div class="attribute-field">
                <div class="attribute-label">Speaks Basic</div>
                <select class="attribute-input" onchange="updateAttribute(${charIndex}, 'speaksBasic', this.value === 'true')" ${char.markedForDelete ? 'disabled' : ''}>
                  <option value="false" ${!char.speaksBasic ? 'selected' : ''}>No</option>
                  <option value="true" ${char.speaksBasic ? 'selected' : ''}>Yes</option>
                </select>
              </div>
              
              <div class="attribute-field">
                <div class="attribute-label">Quote Hint *</div>
                <input type="text" class="attribute-input" value="${char.quoteHint || ''}" onchange="updateAttribute(${charIndex}, 'quoteHint', this.value)" placeholder="Enter a memorable quote..." ${char.markedForDelete ? 'disabled' : ''} />
              </div>
              
              <div class="attribute-field">
                <div class="attribute-label">Master Hint *</div>
                <textarea class="attribute-input" onchange="updateAttribute(${charIndex}, 'masterHint', this.value)" placeholder="Enter a master hint..." ${char.markedForDelete ? 'disabled' : ''} rows="3" style="resize: vertical; font-family: inherit;">${char.masterHint || ''}</textarea>
              </div>
              
              <div class="attribute-field">
                <div class="attribute-label">Movie Appearances</div>
                <div class="multi-select" onclick="${char.markedForDelete ? '' : `openMultiSelect(${charIndex}, 'movieAppearances')`}" style="${char.markedForDelete ? 'opacity: 0.5; cursor: not-allowed;' : 'cursor: pointer;'}">
                  ${(char.movieAppearances || []).map(m => 
                    `<span class="multi-select-tag">${m} ${char.markedForDelete ? '' : `<span class="remove" onclick="event.stopPropagation(); removeFromArray(${charIndex}, 'movieAppearances', '${m.replace(/'/g, "\\'")}')">√ó</span>`}</span>`
                  ).join('')}
                  ${char.markedForDelete ? '' : '<button class="multi-select-add">+ Add</button>'}
                </div>
              </div>
              
              <div class="attribute-field">
                <div class="attribute-label">TV Appearances</div>
                <div class="multi-select" onclick="${char.markedForDelete ? '' : `openMultiSelect(${charIndex}, 'tvAppearances')`}" style="${char.markedForDelete ? 'opacity: 0.5; cursor: not-allowed;' : 'cursor: pointer;'}">
                  ${(char.tvAppearances || []).map(t => 
                    `<span class="multi-select-tag">${t} ${char.markedForDelete ? '' : `<span class="remove" onclick="event.stopPropagation(); removeFromArray(${charIndex}, 'tvAppearances', '${t.replace(/'/g, "\\'")}')">√ó</span>`}</span>`
                  ).join('')}
                  ${char.markedForDelete ? '' : '<button class="multi-select-add">+ Add</button>'}
                </div>
              </div>
              
              <div class="attribute-field">
                <div class="attribute-label">Game Appearances</div>
                <div class="multi-select" onclick="${char.markedForDelete ? '' : `openMultiSelect(${charIndex}, 'gameAppearances')`}" style="${char.markedForDelete ? 'opacity: 0.5; cursor: not-allowed;' : 'cursor: pointer;'}">
                  ${(char.gameAppearances || []).map(g => 
                    `<span class="multi-select-tag">${g} ${char.markedForDelete ? '' : `<span class="remove" onclick="event.stopPropagation(); removeFromArray(${charIndex}, 'gameAppearances', '${g.replace(/'/g, "\\'")}')">√ó</span>`}</span>`
                  ).join('')}
                  ${char.markedForDelete ? '' : '<button class="multi-select-add">+ Add</button>'}
                </div>
              </div>
              
              <div class="attribute-field">
                <div class="attribute-label">Book/Comic Appearances</div>
                <div class="multi-select" onclick="${char.markedForDelete ? '' : `openMultiSelect(${charIndex}, 'bookComicAppearances')`}" style="${char.markedForDelete ? 'opacity: 0.5; cursor: not-allowed;' : 'cursor: pointer;'}">
                  ${(char.bookComicAppearances || []).map(b => 
                    `<span class="multi-select-tag">${b} ${char.markedForDelete ? '' : `<span class="remove" onclick="event.stopPropagation(); removeFromArray(${charIndex}, 'bookComicAppearances', '${b.replace(/'/g, "\\'")}')">√ó</span>`}</span>`
                  ).join('')}
                  ${char.markedForDelete ? '' : '<button class="multi-select-add">+ Add</button>'}
                </div>
              </div>
            </div>
          </div>
        `;
        
        list.appendChild(row);
      });
    }

    function toggleEnabled(index) {
      characters[index].enabled = !characters[index].enabled;
      updateStats();
      renderCharacters();
    }

    function toggleDelete(index) {
      characters[index].markedForDelete = !characters[index].markedForDelete;
      updateStats();
      renderCharacters();
    }

    function updateAttribute(index, attr, value) {
      if (value === 'null') {
        characters[index][attr] = null;
      } else {
        characters[index][attr] = value;
      }
      updateStats();
    }

    function removeFromArray(index, attr, value) {
      const char = characters[index];
      char[attr] = (char[attr] || []).filter(v => v !== value);
      renderCharacters();
    }

    function openAdditionalNames(index) {
      const char = characters[index];
      const newName = prompt('Enter an additional name or alias:');
      
      if (newName && newName.trim()) {
        if (!char.additionalNames) {
          char.additionalNames = [];
        }
        char.additionalNames.push(newName.trim());
        renderCharacters();
      }
    }

    function openMultiSelect(index, attribute) {
      currentDropdownContext = { index, attribute };
      const overlay = document.getElementById('dropdownOverlay');
      const title = document.getElementById('dropdownTitle');
      const options = document.getElementById('dropdownOptions');
      
      title.textContent = `Select ${attribute.charAt(0).toUpperCase() + attribute.slice(1)}`;
      
      const currentValues = characters[index][attribute] || [];
      const availableOptions = attributeOptions[attribute] || [];
      
      options.innerHTML = availableOptions.map(option => {
        const isSelected = currentValues.includes(option);
        return `
          <div class="dropdown-option" onclick="toggleOption('${option}')" style="${isSelected ? 'background: rgba(255, 232, 31, 0.2);' : ''}">
            ${isSelected ? '‚úì ' : ''}${option}
          </div>
        `;
      }).join('');
      
      overlay.classList.add('show');
    }

    function toggleOption(option) {
      const { index, attribute } = currentDropdownContext;
      const char = characters[index];
      
      if (!char[attribute]) {
        char[attribute] = [];
      }
      
      const idx = char[attribute].indexOf(option);
      if (idx > -1) {
        char[attribute].splice(idx, 1);
      } else {
        char[attribute].push(option);
      }
      
      // Re-render the dropdown to show updated selection
      openMultiSelect(index, attribute);
      
      // Update the main view in background
      updateStats();
    }

    function closeDropdown(event) {
      if (!event || event.target.id === 'dropdownOverlay') {
        document.getElementById('dropdownOverlay').classList.remove('show');
        currentDropdownContext = null;
        renderCharacters();
      }
    }

    function createNewCharacter() {
      document.getElementById('newCharName').value = '';
      document.getElementById('newCharEnabled').checked = false;
      document.getElementById('createCharacterModal').classList.add('show');
      // Focus the name input after a brief delay
      setTimeout(() => document.getElementById('newCharName').focus(), 100);
    }

    function closeCreateModal() {
      document.getElementById('createCharacterModal').classList.remove('show');
    }

    function confirmCreateCharacter() {
      const nameInput = document.getElementById('newCharName');
      const enabledCheckbox = document.getElementById('newCharEnabled');
      const name = nameInput.value.trim();
      
      if (!name) {
        alert('‚ùå Please enter a character name.');
        nameInput.focus();
        return;
      }
      
      // Check if character already exists
      const exists = characters.some(c => c.name.toLowerCase() === name.toLowerCase());
      if (exists) {
        alert('‚ùå A character with this name already exists.');
        nameInput.focus();
        return;
      }
      
      // Generate a unique ID
      const generateId = (name) => {
        const base = name.toLowerCase().replace(/[^a-z0-9]/g, '-');
        let id = base;
        let counter = 1;
        while (characters.some(c => c.id === id)) {
          id = `${base}-${counter}`;
          counter++;
        }
        return id;
      };
      
      // Create new character with default values
      const newCharacter = {
        id: generateId(name),
        name: name,
        additionalNames: [],
        species: null,
        sex: null,
        hairColor: null,
        eyeColor: [],
        homeworld: null,
        affiliations: [],
        eras: [],
        weapons: [],
        forceUser: false,
        speaksBasic: true,
        quoteHint: null,
        masterHint: null,
        movieAppearances: [],
        tvAppearances: [],
        gameAppearances: [],
        bookComicAppearances: [],
        enabled: enabledCheckbox.checked,
        imageUrl: null,
        markedForDelete: false
      };
      
      // Add to characters array
      characters.unshift(newCharacter); // Add at the beginning
      
      // Update filtered characters and re-render
      filterView(currentFilter);
      updateStats();
      
      // Close modal
      closeCreateModal();
      
      // Show success message
      const indicator = document.getElementById('saveIndicator');
      indicator.textContent = `‚úÖ Created: ${name}`;
      indicator.classList.add('show');
      setTimeout(() => {
        indicator.classList.remove('show');
        indicator.textContent = '‚úÖ Changes copied to clipboard!';
      }, 3000);
      
      // Scroll to top to show the new character
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function enableAll() {
      filteredCharacters.forEach(char => {
        if (!char.markedForDelete) {
          const index = characters.indexOf(char);
          characters[index].enabled = true;
        }
      });
      updateStats();
      renderCharacters();
    }

    function disableAll() {
      filteredCharacters.forEach(char => {
        if (!char.markedForDelete) {
          const index = characters.indexOf(char);
          characters[index].enabled = false;
        }
      });
      updateStats();
      renderCharacters();
    }

    function openFindReplace() {
      document.getElementById('findReplaceModal').classList.add('show');
      document.getElementById('frAttribute').value = '';
      document.getElementById('frFindValue').innerHTML = '<option value="">-- Select value to find --</option>';
      document.getElementById('frReplaceValue').innerHTML = '<option value="">-- Select replacement value --</option>';
      document.getElementById('frPreview').style.display = 'none';
    }

    function closeFindReplace() {
      document.getElementById('findReplaceModal').classList.remove('show');
    }

    function updateFindReplaceOptions() {
      const attribute = document.getElementById('frAttribute').value;
      const findSelect = document.getElementById('frFindValue');
      const replaceSelect = document.getElementById('frReplaceValue');
      const preview = document.getElementById('frPreview');
      
      preview.style.display = 'none';
      
      if (!attribute) {
        findSelect.innerHTML = '<option value="">-- Select value to find --</option>';
        replaceSelect.innerHTML = '<option value="">-- Select replacement value --</option>';
        return;
      }
      
      // Get all unique values currently in use for this attribute
      const valuesInUse = new Set();
      
      characters.forEach(char => {
        const value = char[attribute];
        if (value === null || value === undefined) return;
        
        if (Array.isArray(value)) {
          value.forEach(v => valuesInUse.add(v));
        } else {
          valuesInUse.add(value);
        }
      });
      
      // Populate find dropdown with values in use
      findSelect.innerHTML = '<option value="">-- Select value to find --</option>';
      Array.from(valuesInUse).sort().forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        findSelect.appendChild(option);
      });
      
      // Populate replace dropdown with all available options
      replaceSelect.innerHTML = '<option value="">-- Select replacement value --</option>';
      const availableOptions = attributeOptions[attribute] || [];
      availableOptions.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        replaceSelect.appendChild(option);
      });
      
      // Add event listeners to show preview
      findSelect.onchange = showFindReplacePreview;
      replaceSelect.onchange = showFindReplacePreview;
    }

    function showFindReplacePreview() {
      const attribute = document.getElementById('frAttribute').value;
      const findValue = document.getElementById('frFindValue').value;
      const replaceValue = document.getElementById('frReplaceValue').value;
      const preview = document.getElementById('frPreview');
      const previewText = document.getElementById('frPreviewText');
      
      if (!attribute || !findValue || !replaceValue) {
        preview.style.display = 'none';
        return;
      }
      
      // Count occurrences
      let count = 0;
      const affectedChars = [];
      
      characters.forEach(char => {
        const value = char[attribute];
        let hasValue = false;
        
        if (Array.isArray(value)) {
          if (value.includes(findValue)) {
            hasValue = true;
            count++;
          }
        } else if (value === findValue) {
          hasValue = true;
          count++;
        }
        
        if (hasValue) {
          affectedChars.push(char.name);
        }
      });
      
      if (count === 0) {
        previewText.innerHTML = `No characters found with <strong>${findValue}</strong> in ${attribute}.`;
      } else {
        const charList = affectedChars.slice(0, 5).join(', ') + (affectedChars.length > 5 ? `, and ${affectedChars.length - 5} more...` : '');
        previewText.innerHTML = `Will replace <strong>${findValue}</strong> with <strong>${replaceValue}</strong> in <strong>${count} character(s)</strong>:<br><br>${charList}`;
      }
      
      preview.style.display = 'block';
    }

    function executeFindReplace() {
      const attribute = document.getElementById('frAttribute').value;
      const findValue = document.getElementById('frFindValue').value;
      const replaceValue = document.getElementById('frReplaceValue').value;
      
      if (!attribute || !findValue || !replaceValue) {
        alert('‚ùå Please select all required fields.');
        return;
      }
      
      if (findValue === replaceValue) {
        alert('‚ùå Find and Replace values cannot be the same.');
        return;
      }
      
      let count = 0;
      
      characters.forEach(char => {
        const value = char[attribute];
        
        if (Array.isArray(value)) {
          const index = value.indexOf(findValue);
          if (index !== -1) {
            // Check if replace value already exists in array
            if (!value.includes(replaceValue)) {
              value[index] = replaceValue;
              count++;
            } else {
              // Remove the find value since replace value already exists
              value.splice(index, 1);
              count++;
            }
          }
        } else if (value === findValue) {
          char[attribute] = replaceValue;
          count++;
        }
      });
      
      if (count === 0) {
        alert('‚ùå No occurrences found to replace.');
        return;
      }
      
      // Update view
      renderCharacters();
      updateStats();
      closeFindReplace();
      
      // Show success message
      const indicator = document.getElementById('saveIndicator');
      indicator.textContent = `‚úÖ Replaced ${count} occurrence(s): "${findValue}" ‚Üí "${replaceValue}"`;
      indicator.classList.add('show');
      setTimeout(() => {
        indicator.classList.remove('show');
        indicator.textContent = '‚úÖ Changes copied to clipboard!';
      }, 4000);
    }

    async function saveChanges() {
      const saveButton = event.target;
      saveButton.disabled = true;
      saveButton.textContent = 'üíæ Saving...';
      
      try {
        // Filter out characters marked for deletion
        const charactersToSave = characters.filter(c => !c.markedForDelete);
        
        // Remove markedForDelete flag from the output
        const cleanedCharacters = charactersToSave.map(char => {
          const { markedForDelete, ...rest } = char;
          return rest;
        });
        
        const json = JSON.stringify(cleanedCharacters, null, 2);
        await navigator.clipboard.writeText(json);
        
        // Show save indicator
        const indicator = document.getElementById('saveIndicator');
        indicator.classList.add('show');
        setTimeout(() => indicator.classList.remove('show'), 3000);
        
        alert(`‚úÖ Character data copied to clipboard!\n\n${charactersToSave.length} characters included.\n${characters.length - charactersToSave.length} characters marked for deletion were excluded.\n\nPaste it into src/data/characters.json to save your changes.`);
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      } finally {
        saveButton.disabled = false;
        saveButton.textContent = 'üíæ Save Changes';
      }
    }

    // Populate character info from Fandom
    const API_BASE_URL = 'http://localhost:3001';

    async function populateCharacterInfo(charIndex, populateAll = false) {
      const char = characters[charIndex];
      
      if (!char || char.markedForDelete) {
        return;
      }
      
      const buttonText = populateAll ? 'Populate All' : 'Populate Missing';
      const indicator = document.getElementById('saveIndicator');
      
      try {
        indicator.textContent = `‚è≥ ${buttonText} for ${char.name}...`;
        indicator.classList.add('show');
        
        // Check if API server is running
        let serverRunning = false;
        try {
          const healthCheck = await fetch(`${API_BASE_URL}/health`, { signal: AbortSignal.timeout(2000) });
          serverRunning = healthCheck.ok;
        } catch (e) {
          // Server not running
        }
        
        if (!serverRunning) {
          indicator.classList.remove('show');
          const message = `‚ùå API Server Not Running!\n\nTo use this feature, start the API server:\n\n1. Open a terminal\n2. Run: npm run character-api\n\nThe server will start on http://localhost:3001`;
          alert(message);
          return;
        }
        
        const response = await fetch(`${API_BASE_URL}/api/populate-character`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            characterId: char.id,
            characterName: char.name,
            populateAll: populateAll,
            currentData: char
          })
        });
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to populate character info');
        }
        
        // Update character with populated data
        if (result.data) {
          Object.keys(result.data).forEach(key => {
            if (result.data[key] !== null && result.data[key] !== undefined) {
              characters[charIndex][key] = result.data[key];
            }
          });
        }
        
        // Add or update fandomUrl
        if (result.fandomUrl) {
          characters[charIndex].fandomUrl = result.fandomUrl;
        }
        
        // Show success message
        const cacheInfo = result.fromCache ? ' (from cache)' : ' (downloaded fresh)';
        const fieldsUpdated = Object.keys(result.data || {}).length;
        indicator.textContent = `‚úÖ ${char.name}: ${fieldsUpdated} field(s) updated${cacheInfo}`;
        
        // Re-render the character list
        renderCharacters();
        
        setTimeout(() => {
          indicator.classList.remove('show');
          indicator.textContent = '‚úÖ Changes copied to clipboard!';
        }, 5000);
        
      } catch (error) {
        indicator.classList.remove('show');
        alert(`‚ùå Error populating ${char.name}:\n\n${error.message}`);
        console.error('Populate error:', error);
      }
    }

    async function populateMissingInfo(charIndex) {
      if (confirm(`This will populate only the MISSING fields for this character from Fandom.\n\nExisting data will be preserved.\n\nContinue?`)) {
        await populateCharacterInfo(charIndex, false);
      }
    }

    async function populateAllInfo(charIndex) {
      const char = characters[charIndex];
      if (confirm(`‚ö†Ô∏è WARNING: This will REPLACE ALL fields for "${char.name}" with data from Fandom.\n\nThis will overwrite any existing data you have entered manually.\n\nContinue?`)) {
        await populateCharacterInfo(charIndex, true);
      }
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
      filterView(currentFilter);
    });

    // Load on startup
    loadData();
  </script>
</body>
</html>
